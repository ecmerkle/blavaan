<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="blavaan">
<title>Convergence and Efficiency Evaluation • blavaan</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Convergence and Efficiency Evaluation">
<meta property="og:description" content="blavaan">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">blavaan</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5-2.1220</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-basics">Basics</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-basics">
    <a class="dropdown-item" href="../articles/start.html">Getting Started</a>
    <a class="dropdown-item" href="../articles/prior.html">Prior Specification</a>
    <a class="dropdown-item" href="../articles/estimate.html">Estimation</a>
    <a class="dropdown-item" href="../articles/convergence_efficiency.html">Convergence and Efficiency Evaluation</a>
    <a class="dropdown-item" href="../articles/summaries.html">Model Summaries</a>
    <a class="dropdown-item" href="../articles/plotting.html">Plots</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples-details">Examples/Details</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples-details">
    <a class="dropdown-item" href="../articles/ordinal.html">Estimation with Ordinal Data</a>
    <a class="dropdown-item" href="../articles/multilevel.html">Two-level Estimation</a>
    <a class="dropdown-item" href="../articles/invariance.html">Measurement Invariance</a>
    <a class="dropdown-item" href="../articles/approx_fi.html">Approximate Fit Indices</a>
    <a class="dropdown-item" href="../articles/model_comparison.html">Model Comparison</a>
    <a class="dropdown-item" href="../articles/cross_loadings_strong_priors.html">Cross-loadings with Strong Priors</a>
    <a class="dropdown-item" href="../articles/mod_indices.html">Modification Indices</a>
    <a class="dropdown-item" href="../articles/prior_pred_checks.html">Prior Predictive Checks</a>
    <a class="dropdown-item" href="../articles/convergence_loop.html">Convergence Loop</a>
    <a class="dropdown-item" href="../articles/probability_direction.html">Probability of Direction</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/resources.html">Resources</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ecmerkle/blavaan">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://groups.google.com/d/forum/blavaan">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Convergence and Efficiency Evaluation</h1>
                        <h4 data-toc-skip class="author">Mauricio
Garnier-Villarreal</h4>
            
      
      
      <div class="d-none name"><code>convergence_efficiency.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>When Bayesian models are estimated with a Markov-Chain Monte Carlo
(MCMC) sampler, the model estimation doesn’t stop when it has achieved
some convergence criteria. It will run as long as desired (determined by
the <code>burnin</code> and <code>sample</code> arguments), and then you
need to evaluate the convergence and efficiency of the estimated
posterior distributions. You should only analyze the results if
convergence has been achieved, as judged by the metrics described
below.</p>
<p>For this example we will use the Industrialization and Political
Democracy example <span class="citation">(Bollen 1989)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">  # latent variable definitions</span></span>
<span><span class="st">     ind60 =~ x1 + x2 + x3</span></span>
<span><span class="st">     dem60 =~ a*y1 + b*y2 + c*y3 + d*y4</span></span>
<span><span class="st">     dem65 =~ a*y5 + b*y6 + c*y7 + d*y8</span></span>
<span><span class="st"></span></span>
<span><span class="st">  # regressions</span></span>
<span><span class="st">    dem60 ~ ind60</span></span>
<span><span class="st">    dem65 ~ ind60 + dem60</span></span>
<span><span class="st"></span></span>
<span><span class="st">  # residual correlations</span></span>
<span><span class="st">    y1 ~~ y5</span></span>
<span><span class="st">    y2 ~~ y4 + y6</span></span>
<span><span class="st">    y3 ~~ y7</span></span>
<span><span class="st">    y4 ~~ y8</span></span>
<span><span class="st">    y6 ~~ y8</span></span>
<span><span class="st">'</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bsem.html">bsem</a></span><span class="op">(</span><span class="va">model</span>, data<span class="op">=</span><span class="va">PoliticalDemocracy</span>,</span>
<span>            std.lv<span class="op">=</span><span class="cn">T</span>, meanstructure<span class="op">=</span><span class="cn">T</span>, n.chains<span class="op">=</span><span class="fl">3</span>,</span>
<span>            burnin<span class="op">=</span><span class="fl">500</span>, sample<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="convergence">Convergence<a class="anchor" aria-label="anchor" href="#convergence"></a>
</h3>
<p>The primary convergence diagnostic is that <span class="math inline">\(\hat{R}\)</span>, which compares the between- and
within-chain samples of model parameters and other univariate quantities
of interest <span class="citation">(Vehtari et al. 2021)</span>. If
chains have not mixed well (ie, the between- and within-chain estimates
don’t agree), <span class="math inline">\(\hat{R}\)</span> is larger
than 1. We recommend running at least three chains by default and only
using the posterior samples if <span class="math inline">\(\hat{R} &lt;
1.05\)</span> for all the parameters.</p>
<p><code>blavaan</code> presents the <span class="math inline">\(\hat{R}\)</span> reported by the underlying MCMC
program, either Stan or JAGS (Stan by default). We can obtain the <span class="math inline">\(\hat{R}\)</span> from the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>
function, and we can also extract it with the <code><a href="../reference/blavInspect.html">blavInspect()</a></code>
function</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/blavInspect.html">blavInspect</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"rhat"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   ind60=~x1   ind60=~x2   ind60=~x3           a           b           c </span></span>
<span><span class="co">##   1.0009557   1.0012469   1.0005321   0.9995079   1.0003013   0.9997834 </span></span>
<span><span class="co">##           d           a           b           c           d dem60~ind60 </span></span>
<span><span class="co">##   0.9999357   0.9995079   1.0003013   0.9997834   0.9999357   1.0005672 </span></span>
<span><span class="co">## dem65~ind60 dem65~dem60      y1~~y5      y2~~y4      y2~~y6      y3~~y7 </span></span>
<span><span class="co">##   0.9991611   0.9998544   1.0006864   0.9992197   1.0005899   1.0002132 </span></span>
<span><span class="co">##      y4~~y8      y6~~y8      x1~~x1      x2~~x2      x3~~x3      y1~~y1 </span></span>
<span><span class="co">##   0.9995204   1.0010297   1.0009589   1.0009921   0.9995236   1.0004152 </span></span>
<span><span class="co">##      y2~~y2      y3~~y3      y4~~y4      y5~~y5      y6~~y6      y7~~y7 </span></span>
<span><span class="co">##   0.9998460   1.0000590   0.9998368   1.0006159   1.0006753   0.9994226 </span></span>
<span><span class="co">##      y8~~y8        x1~1        x2~1        x3~1        y1~1        y2~1 </span></span>
<span><span class="co">##   1.0000161   1.0032499   1.0038304   1.0027023   1.0042612   1.0042941 </span></span>
<span><span class="co">##        y3~1        y4~1        y5~1        y6~1        y7~1        y8~1 </span></span>
<span><span class="co">##   1.0049730   1.0064858   1.0039609   1.0048756   1.0050328   1.0057915</span></span></code></pre>
<p>With large models it can be cumbersome to look over all of these
entries. We can instead find the largest <span class="math inline">\(\hat{R}\)</span> to see if they are all less than
<span class="math inline">\(1.05\)</span></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="../reference/blavInspect.html">blavInspect</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"psrf"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1.006486</span></span></code></pre>
<p>If all <span class="math inline">\(\hat{R} &lt; 1.05\)</span> then we
can establish that the MCMC chains have converged to a stable solution.
If the model has not converged, you might increase the number of
<code>burnin</code> iterations</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bsem.html">bsem</a></span><span class="op">(</span><span class="va">model</span>, data<span class="op">=</span><span class="va">PoliticalDemocracy</span>,</span>
<span>            std.lv<span class="op">=</span><span class="cn">T</span>, meanstructure<span class="op">=</span><span class="cn">T</span>, n.chains<span class="op">=</span><span class="fl">3</span>,</span>
<span>            burnin<span class="op">=</span><span class="fl">1000</span>, sample<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>and/or change the model priors with the <code><a href="../reference/dpriors.html">dpriors()</a></code>
function. These address issues where the model failed to converge due to
needing more iterations or due to a model misspecification (such as bad
priors). As a rule of thumb, we seldom see a model require more than
1,000 burnin samples in Stan. If your model is not converging after
1,000 burnin samples, it is likely that the default prior distributions
clash with your data. This can happen, e.g., if your variables contain
values in the 100s or 1000s.</p>
</div>
<div class="section level3">
<h3 id="efficiency">Efficiency<a class="anchor" aria-label="anchor" href="#efficiency"></a>
</h3>
<p>We should also evaluate the efficiency of the posterior samples.
Effective sample size (ESS) is a useful measure for sampling efficiency,
and is well defined even if the chains do not have finite mean or
variance <span class="citation">(Vehtari et al. 2021)</span>.</p>
<p>In short, the posterior samples produced by MCMC are autocorrelated.
This means that, if you draw 500 posterior samples, you do not have 500
independent pieces of information about the posterior distribution,
because the samples are autocorlated. The ESS metric is
<a href="https://www.johndcook.com/blog/2017/06/27/effective-sample-size-for-mcmc/" class="external-link">like
a currency conversion,</a> telling you how much your autocorrelated
samples are worth if we were to convert them to indepndent samples. In
<code>blavaan</code> we can print it from the <code>summary</code>
function with the <code>neff</code> argument</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span>, neff<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>We can also extract only those with the <code><a href="../reference/blavInspect.html">blavInspect()</a></code>
function</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/blavInspect.html">blavInspect</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"neff"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   ind60=~x1   ind60=~x2   ind60=~x3           a           b           c </span></span>
<span><span class="co">##   1369.3400   1213.4057   1624.7713   1860.4676   1765.3861   2056.3022 </span></span>
<span><span class="co">##           d           a           b           c           d dem60~ind60 </span></span>
<span><span class="co">##   1636.3695   1860.4676   1765.3861   2056.3022   1636.3695   2043.3491 </span></span>
<span><span class="co">## dem65~ind60 dem65~dem60      y1~~y5      y2~~y4      y2~~y6      y3~~y7 </span></span>
<span><span class="co">##   2953.5110   2734.0975   2236.7778   2189.7919   2967.9556   2523.2426 </span></span>
<span><span class="co">##      y4~~y8      y6~~y8      x1~~x1      x2~~x2      x3~~x3      y1~~y1 </span></span>
<span><span class="co">##   3194.5352   2047.4786   2438.3384   2474.7607   3253.3711   2392.6656 </span></span>
<span><span class="co">##      y2~~y2      y3~~y3      y4~~y4      y5~~y5      y6~~y6      y7~~y7 </span></span>
<span><span class="co">##   2901.3235   3036.7717   2630.1204   2811.7705   2535.6041   2985.8332 </span></span>
<span><span class="co">##      y8~~y8        x1~1        x2~1        x3~1        y1~1        y2~1 </span></span>
<span><span class="co">##   2276.6342   1074.0802    963.9918   1075.0146   1070.2766   1194.6440 </span></span>
<span><span class="co">##        y3~1        y4~1        y5~1        y6~1        y7~1        y8~1 </span></span>
<span><span class="co">##   1223.5768   1033.1738   1010.4970   1038.8179    874.5242    898.0123</span></span></code></pre>
<p>ESS is a sample size, so it should be at least 100 (optimally, much
more than 100) times the number of chains in order to be reliable and to
indicate that estimates of the posterior quantiles are reliable. In this
example, because we have 3 chains, we would want to see at least
<code>neff=300</code> for every parameter.</p>
<p>And we can easily find the lowest ESS with the <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min()</a></code>
function:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="../reference/blavInspect.html">blavInspect</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"neff"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 874.5242</span></span></code></pre>
</div>
<div class="section level3 unnumbered">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-bollen_structural_1989" class="csl-entry">
Bollen, Kenneth A. 1989. <em>Structural <span>Equations</span> with
<span>Latent</span> <span>Variables</span></em>. Wiley Series in
Probability and Mathematical Statistics. John Wiley &amp; Sons, Inc.
</div>
<div id="ref-new_rhat" class="csl-entry">
Vehtari, Aki, Andrew Gelman, Daniel Simpson, Bob Carpenter, and
Paul-Christian Bürkner. 2021. <span>“<span class="nocase">Rank-Normalization, Folding, and Localization: An
Improved <span class="math inline">\(\widehat{R}\)</span> for Assessing
Convergence of MCMC (with Discussion)</span>.”</span> <em>Bayesian
Analysis</em> 16 (2): 667–718. <a href="https://doi.org/10.1214/20-BA1221" class="external-link">https://doi.org/10.1214/20-BA1221</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Edgar Merkle, Yves Rosseel, Ben Goodrich.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>

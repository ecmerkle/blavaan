<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Convergence and Efficiency Evaluation • blavaan</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Convergence and Efficiency Evaluation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">blavaan</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5-5.1296</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-basics" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Basics</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-basics">
<li><a class="dropdown-item" href="../articles/start.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/prior.html">Prior Specification</a></li>
    <li><a class="dropdown-item" href="../articles/estimate.html">Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/convergence_efficiency.html">Convergence and Efficiency Evaluation</a></li>
    <li><a class="dropdown-item" href="../articles/summaries.html">Model Summaries</a></li>
    <li><a class="dropdown-item" href="../articles/plotting.html">Plots</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples-details" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples/Details</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples-details">
<li><a class="dropdown-item" href="../articles/ordinal.html">Estimation with Ordinal Data</a></li>
    <li><a class="dropdown-item" href="../articles/multilevel.html">Two-level Estimation</a></li>
    <li><a class="dropdown-item" href="../articles/invariance.html">Measurement Invariance</a></li>
    <li><a class="dropdown-item" href="../articles/approx_fi.html">Approximate Fit Indices</a></li>
    <li><a class="dropdown-item" href="../articles/model_comparison.html">Model Comparison</a></li>
    <li><a class="dropdown-item" href="../articles/cross_loadings_strong_priors.html">Cross-loadings with Strong Priors</a></li>
    <li><a class="dropdown-item" href="../articles/mod_indices.html">Modification Indices</a></li>
    <li><a class="dropdown-item" href="../articles/prior_pred_checks.html">Prior Predictive Checks</a></li>
    <li><a class="dropdown-item" href="../articles/convergence_loop.html">Convergence Loop</a></li>
    <li><a class="dropdown-item" href="../articles/probability_direction.html">Probability of Direction</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/resources.html">Resources</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ecmerkle/blavaan"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://groups.google.com/d/forum/blavaan"><span class="fa fa-users"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Convergence and Efficiency Evaluation</h1>
                        <h4 data-toc-skip class="author">Mauricio
Garnier-Villarreal</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ecmerkle/blavaan/blob/master/vignettes/convergence_efficiency.Rmd" class="external-link"><code>vignettes/convergence_efficiency.Rmd</code></a></small>
      <div class="d-none name"><code>convergence_efficiency.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>When Bayesian models are estimated with a Markov-Chain Monte Carlo
(MCMC) sampler, the model estimation doesn’t stop when it has achieved
some convergence criteria. It will run as long as desired (determined by
the <code>burnin</code> and <code>sample</code> arguments), and then you
need to evaluate the convergence and efficiency of the estimated
posterior distributions. You should only analyze the results if
convergence has been achieved, as judged by the metrics described
below.</p>
<p>For this example we will use the Industrialization and Political
Democracy example <span class="citation">(Bollen 1989)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">  # latent variable definitions</span></span>
<span><span class="st">     ind60 =~ x1 + x2 + x3</span></span>
<span><span class="st">     dem60 =~ a*y1 + b*y2 + c*y3 + d*y4</span></span>
<span><span class="st">     dem65 =~ a*y5 + b*y6 + c*y7 + d*y8</span></span>
<span><span class="st"></span></span>
<span><span class="st">  # regressions</span></span>
<span><span class="st">    dem60 ~ ind60</span></span>
<span><span class="st">    dem65 ~ ind60 + dem60</span></span>
<span><span class="st"></span></span>
<span><span class="st">  # residual correlations</span></span>
<span><span class="st">    y1 ~~ y5</span></span>
<span><span class="st">    y2 ~~ y4 + y6</span></span>
<span><span class="st">    y3 ~~ y7</span></span>
<span><span class="st">    y4 ~~ y8</span></span>
<span><span class="st">    y6 ~~ y8</span></span>
<span><span class="st">'</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bsem.html">bsem</a></span><span class="op">(</span><span class="va">model</span>, data<span class="op">=</span><span class="va">PoliticalDemocracy</span>,</span>
<span>            std.lv<span class="op">=</span><span class="cn">T</span>, meanstructure<span class="op">=</span><span class="cn">T</span>, n.chains<span class="op">=</span><span class="fl">3</span>,</span>
<span>            burnin<span class="op">=</span><span class="fl">500</span>, sample<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="convergence">Convergence<a class="anchor" aria-label="anchor" href="#convergence"></a>
</h3>
<p>The primary convergence diagnostic is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>,
which compares the between- and within-chain samples of model parameters
and other univariate quantities of interest <span class="citation">(Vehtari et al. 2021)</span>. If chains have not mixed
well (ie, the between- and within-chain estimates don’t agree),
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>
is larger than 1. We recommend running at least three chains by default
and only using the posterior samples if
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>R</mi><mo accent="true">̂</mo></mover><mo>&lt;</mo><mn>1.05</mn></mrow><annotation encoding="application/x-tex">\hat{R} &lt; 1.05</annotation></semantics></math>
for all the parameters.</p>
<p><code>blavaan</code> presents the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>
reported by the underlying MCMC program, either Stan or JAGS (Stan by
default). We can obtain the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>
from the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> function, and we can also extract it
with the <code><a href="../reference/blavInspect.html">blavInspect()</a></code> function</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/blavInspect.html">blavInspect</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"rhat"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   ind60=~x1   ind60=~x2   ind60=~x3           a           b           c </span></span>
<span><span class="co">##   0.9998329   1.0009269   1.0012448   1.0002433   0.9996886   0.9997942 </span></span>
<span><span class="co">##           d           a           b           c           d dem60~ind60 </span></span>
<span><span class="co">##   0.9996935   1.0002433   0.9996886   0.9997942   0.9996935   1.0004682 </span></span>
<span><span class="co">## dem65~ind60 dem65~dem60      y1~~y5      y2~~y4      y2~~y6      y3~~y7 </span></span>
<span><span class="co">##   0.9994272   0.9995837   1.0001069   0.9996087   0.9993587   0.9993821 </span></span>
<span><span class="co">##      y4~~y8      y6~~y8      x1~~x1      x2~~x2      x3~~x3      y1~~y1 </span></span>
<span><span class="co">##   1.0004460   0.9993719   1.0002074   0.9992664   0.9996132   0.9999948 </span></span>
<span><span class="co">##      y2~~y2      y3~~y3      y4~~y4      y5~~y5      y6~~y6      y7~~y7 </span></span>
<span><span class="co">##   0.9996140   0.9992549   0.9998172   1.0000120   0.9993669   0.9993283 </span></span>
<span><span class="co">##      y8~~y8        x1~1        x2~1        x3~1        y1~1        y2~1 </span></span>
<span><span class="co">##   0.9995331   1.0062831   1.0058931   1.0048471   1.0032289   1.0025551 </span></span>
<span><span class="co">##        y3~1        y4~1        y5~1        y6~1        y7~1        y8~1 </span></span>
<span><span class="co">##   1.0006281   1.0035112   1.0024221   1.0042214   1.0050368   1.0028954</span></span></code></pre>
<p>With large models it can be cumbersome to look over all of these
entries. We can instead find the largest
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>
to see if they are all less than
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1.05</mn><annotation encoding="application/x-tex">1.05</annotation></semantics></math></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="../reference/blavInspect.html">blavInspect</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"psrf"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1.006283</span></span></code></pre>
<p>If all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>R</mi><mo accent="true">̂</mo></mover><mo>&lt;</mo><mn>1.05</mn></mrow><annotation encoding="application/x-tex">\hat{R} &lt; 1.05</annotation></semantics></math>
then we can establish that the MCMC chains have converged to a stable
solution. If the model has not converged, you might increase the number
of <code>burnin</code> iterations</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bsem.html">bsem</a></span><span class="op">(</span><span class="va">model</span>, data<span class="op">=</span><span class="va">PoliticalDemocracy</span>,</span>
<span>            std.lv<span class="op">=</span><span class="cn">T</span>, meanstructure<span class="op">=</span><span class="cn">T</span>, n.chains<span class="op">=</span><span class="fl">3</span>,</span>
<span>            burnin<span class="op">=</span><span class="fl">1000</span>, sample<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>and/or change the model priors with the <code><a href="../reference/dpriors.html">dpriors()</a></code>
function. These address issues where the model failed to converge due to
needing more iterations or due to a model misspecification (such as bad
priors). As a rule of thumb, we seldom see a model require more than
1,000 burnin samples in Stan. If your model is not converging after
1,000 burnin samples, it is likely that the default prior distributions
clash with your data. This can happen, e.g., if your variables contain
values in the 100s or 1000s.</p>
</div>
<div class="section level3">
<h3 id="efficiency">Efficiency<a class="anchor" aria-label="anchor" href="#efficiency"></a>
</h3>
<p>We should also evaluate the efficiency of the posterior samples.
Effective sample size (ESS) is a useful measure for sampling efficiency,
and is well defined even if the chains do not have finite mean or
variance <span class="citation">(Vehtari et al. 2021)</span>.</p>
<p>In short, the posterior samples produced by MCMC are autocorrelated.
This means that, if you draw 500 posterior samples, you do not have 500
independent pieces of information about the posterior distribution,
because the samples are autocorlated. The ESS metric is
<a href="https://www.johndcook.com/blog/2017/06/27/effective-sample-size-for-mcmc/" class="external-link">like
a currency conversion,</a> telling you how much your autocorrelated
samples are worth if we were to convert them to independent samples. In
<code>blavaan</code> we can print it from the <code>summary</code>
function with the <code>neff</code> argument</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span>, neff<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>We can also extract only those with the <code><a href="../reference/blavInspect.html">blavInspect()</a></code>
function</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/blavInspect.html">blavInspect</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"neff"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   ind60=~x1   ind60=~x2   ind60=~x3           a           b           c </span></span>
<span><span class="co">##    1788.407    1643.328    1871.459    2173.497    2498.604    2204.155 </span></span>
<span><span class="co">##           d           a           b           c           d dem60~ind60 </span></span>
<span><span class="co">##    2119.537    2173.497    2498.604    2204.155    2119.537    2678.910 </span></span>
<span><span class="co">## dem65~ind60 dem65~dem60      y1~~y5      y2~~y4      y2~~y6      y3~~y7 </span></span>
<span><span class="co">##    3760.840    3330.003    2711.883    2571.530    3307.739    2654.652 </span></span>
<span><span class="co">##      y4~~y8      y6~~y8      x1~~x1      x2~~x2      x3~~x3      y1~~y1 </span></span>
<span><span class="co">##    2717.897    1776.845    2168.178    1809.031    3810.470    2942.691 </span></span>
<span><span class="co">##      y2~~y2      y3~~y3      y4~~y4      y5~~y5      y6~~y6      y7~~y7 </span></span>
<span><span class="co">##    3547.369    3427.482    2621.538    2290.928    2491.826    2377.952 </span></span>
<span><span class="co">##      y8~~y8        x1~1        x2~1        x3~1        y1~1        y2~1 </span></span>
<span><span class="co">##    1805.490    1278.027    1223.059    1368.768    1422.557    1651.289 </span></span>
<span><span class="co">##        y3~1        y4~1        y5~1        y6~1        y7~1        y8~1 </span></span>
<span><span class="co">##    1565.144    1332.832    1329.148    1415.159    1332.593    1329.845</span></span></code></pre>
<p>ESS is a sample size, so it should be at least 100 (optimally, much
more than 100) times the number of chains in order to be reliable and to
indicate that estimates of the posterior quantiles are reliable. In this
example, because we have 3 chains, we would want to see at least
<code>neff=300</code> for every parameter.</p>
<p>And we can easily find the lowest ESS with the <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min()</a></code>
function:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="../reference/blavInspect.html">blavInspect</a></span><span class="op">(</span><span class="va">fit</span>, <span class="st">"neff"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1223.059</span></span></code></pre>
</div>
<div class="section level3 unnumbered">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bollen_structural_1989" class="csl-entry">
Bollen, Kenneth A. 1989. <em>Structural <span>Equations</span> with
<span>Latent</span> <span>Variables</span></em>. Wiley Series in
Probability and Mathematical Statistics. John Wiley &amp; Sons, Inc.
</div>
<div id="ref-new_rhat" class="csl-entry">
Vehtari, Aki, Andrew Gelman, Daniel Simpson, Bob Carpenter, and
Paul-Christian Bürkner. 2021. <span>“<span class="nocase">Rank-Normalization, Folding, and Localization: An
Improved
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\widehat{R}</annotation></semantics></math>
for Assessing Convergence of MCMC (with Discussion)</span>.”</span>
<em>Bayesian Analysis</em> 16 (2): 667–718. <a href="https://doi.org/10.1214/20-BA1221" class="external-link">https://doi.org/10.1214/20-BA1221</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Edgar Merkle, Yves Rosseel, Ben Goodrich.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>

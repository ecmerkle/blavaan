<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="blavaan">
<title>Two-level SEM • blavaan</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Two-level SEM">
<meta property="og:description" content="blavaan">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">blavaan</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5-3.1253</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-basics">Basics</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-basics">
    <a class="dropdown-item" href="../articles/start.html">Getting Started</a>
    <a class="dropdown-item" href="../articles/prior.html">Prior Specification</a>
    <a class="dropdown-item" href="../articles/estimate.html">Estimation</a>
    <a class="dropdown-item" href="../articles/convergence_efficiency.html">Convergence and Efficiency Evaluation</a>
    <a class="dropdown-item" href="../articles/summaries.html">Model Summaries</a>
    <a class="dropdown-item" href="../articles/plotting.html">Plots</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-examples-details">Examples/Details</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-examples-details">
    <a class="dropdown-item" href="../articles/ordinal.html">Estimation with Ordinal Data</a>
    <a class="dropdown-item" href="../articles/multilevel.html">Two-level Estimation</a>
    <a class="dropdown-item" href="../articles/invariance.html">Measurement Invariance</a>
    <a class="dropdown-item" href="../articles/approx_fi.html">Approximate Fit Indices</a>
    <a class="dropdown-item" href="../articles/model_comparison.html">Model Comparison</a>
    <a class="dropdown-item" href="../articles/cross_loadings_strong_priors.html">Cross-loadings with Strong Priors</a>
    <a class="dropdown-item" href="../articles/mod_indices.html">Modification Indices</a>
    <a class="dropdown-item" href="../articles/prior_pred_checks.html">Prior Predictive Checks</a>
    <a class="dropdown-item" href="../articles/convergence_loop.html">Convergence Loop</a>
    <a class="dropdown-item" href="../articles/probability_direction.html">Probability of Direction</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/resources.html">Resources</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Functions</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ecmerkle/blavaan">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://groups.google.com/d/forum/blavaan">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Two-level SEM</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ecmerkle/blavaan/blob/HEAD/vignettes/multilevel.Rmd" class="external-link"><code>vignettes/multilevel.Rmd</code></a></small>
      <div class="d-none name"><code>multilevel.Rmd</code></div>
    </div>

    
    
<p>Starting with version 0.5-1, <em>blavaan</em> supports two-level SEM
with random intercepts. The specification and estimation commands are
similar to those of <em>lavaan</em>, including use of
<code>level:</code> in the model specification and use of the
<code>cluster</code> argument for estimation. Consequently, examples
involving <em>lavaan</em> also generally apply to <em>blavaan</em>, such
as the <em>lavaan</em> tutorial example below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">Demo.twolevel</span>, package <span class="op">=</span> <span class="st">"lavaan"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="st">'</span></span>
<span><span class="st">    level: within</span></span>
<span><span class="st">        fw =~ y1 + y2 + y3</span></span>
<span><span class="st">        fw ~ x1 + x2 + x3</span></span>
<span><span class="st">    level: between</span></span>
<span><span class="st">        fb =~ y1 + y2 + y3</span></span>
<span><span class="st">        fb ~ w1 + w2</span></span>
<span><span class="st">'</span></span>
<span></span>
<span><span class="va">bfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bsem.html">bsem</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">model</span>, data <span class="op">=</span> <span class="va">Demo.twolevel</span>, cluster <span class="op">=</span> <span class="st">"cluster"</span><span class="op">)</span></span></code></pre></div>
<p>Below, we discuss what is currently covered by <em>blavaan</em> and
some features that are unique to Bayesian modeling.</p>
<div class="section level3">
<h3 id="blavaan-coverage">
<em>blavaan</em> Coverage<a class="anchor" aria-label="anchor" href="#blavaan-coverage"></a>
</h3>
<p>As of version 0.5-1, <em>blavaan</em> handles two-level, random
intercept models for complete, continuous data. Handling missing data
(assuming missingness at random) will come in a future release. In the
meantime, multiple imputation might be used in combination with the
current <em>blavaan</em> functionality (though there is not currently an
automatic way to do it). Alternatively, if there is not much missing
data and it occurs only for lower-level units, listwise deletion could
work.</p>
<p>The <em>blavaan</em> approach to model estimation mimics the
<em>lavaan</em> approach, which uses matrix results <span class="citation">(see Rosseel 2021)</span> that enable us to efficiently
evaluate the multilevel SEM likelihood. This will often lead to more
efficient MCMC estimation, as compared to sampling all the level 1 and
level 2 latent variables and working with conditional likelihoods <span class="citation">(see Merkle et al. 2021 for discussion of marginal vs
conditional likelihoods)</span>.</p>
<p>Similar to single-level models, users can sample latent variables
using the <code>save.lvs = TRUE</code> argument in their
<code>bcfa/bsem/bgrowth/blavaan</code> commands. Marginal information
criteria (marginal over all latent variables) are also automatically
computed, with these information criteria generally being preferred over
those than condition on latent variables <span class="citation">(see
Merkle, Furr, and Rabe-Hesketh 2019 for detail in the context of
single-level models)</span>.</p>
</div>
<div class="section level3">
<h3 id="bayes-specific-options">Bayes-specific Options<a class="anchor" aria-label="anchor" href="#bayes-specific-options"></a>
</h3>
<p>All Bayesian models require prior distributions. The previous
<em>blavaan</em> defaults for single-level models are now used for
two-level models. You can continue to use commands like
<code>dpriors(lambda = "normal(1,.5)")</code> to specify a Normal(1,.5)
prior for all factor loadings and, for two-level models, that
specification will apply to both the level 1 and level 2 loadings.
Depending on the model, it may also be useful to specify priors on
individual parameters via the <code>prior()</code> argument inside the
model specification syntax. The default prior distributions do not
always work well for observed variables whose values are far from 0. We
continue to encourage users to consider their own prior distributions,
possibly using the <code>prisamp = TRUE</code> option to draw samples
from the prior (which could be further used for prior predictive
checking).</p>
<p>Model checking also differs between Bayesian and frequentist methods.
Just like it did for one-level models, <em>blavaan</em> reports a
posterior predictive p-value for general model assessment. This is
computed by comparing the marginal likelihood of the observed data
(marginal over all latent variables) to the marginal likelihood of
artificial data, for each iteration of MCMC sampling. For finer-grained
model assessment, we encourage users to try <code><a href="../reference/ppmc.html">ppmc()</a></code>. It
allows you to compute a posterior predictive p-value using your own,
custom model assessment (defined as an R function).</p>
</div>
<div class="section level3">
<h3 id="concluding-thoughts">Concluding Thoughts<a class="anchor" aria-label="anchor" href="#concluding-thoughts"></a>
</h3>
<p>We think that the new <em>blavaan</em> functionality provides a
viable option for Bayesian two-level SEM, and it should provide a solid
base for future model developments. As always, the underlying Stan files
and supporting data are available via the <code>mcmcfile = TRUE</code>
argument, and all the <em>blavaan</em> code is available on Github. Bug
reports are appreciated, either at the <em>blavaan</em> Google group or
as a Github issue.</p>
</div>
<div class="section level3 unnumbered">
<h3 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-merfit21" class="csl-entry">
Merkle, E. C., E. Fitzsimmons, J. Uanhoro, and B. Goodrich. 2021.
<span>“Efficient <span>Bayesian</span> Structural Equation Modeling in
<span>Stan</span>.”</span> <em>Journal of Statistical Software</em> 100
(6): 1–22. <a href="https://www.jstatsoft.org/article/view/v100i06" class="external-link">https://www.jstatsoft.org/article/view/v100i06</a>.
</div>
<div id="ref-merfur19" class="csl-entry">
Merkle, E. C., D. Furr, and S. Rabe-Hesketh. 2019.
<span>“<span>Bayesian</span> Comparison of Latent Variable Models:
<span>Conditional</span> Versus Marginal Likelihoods.”</span>
<em>Psychometrika</em> 84: 802–29. <a href="https://arxiv.org/abs/1802.04452" class="external-link">https://arxiv.org/abs/1802.04452</a>.
</div>
<div id="ref-ros21" class="csl-entry">
Rosseel, Yves. 2021. <span>“Evaluating the Observed Log-Likelihood
Function in Two-Level Structural Equation Modeling with Missing Data:
<span>From</span> Formulas to <span>R</span> Code.”</span>
<em>Psych</em> 3 (2): 197–232. <a href="https://doi.org/10.3390/psych3020017" class="external-link">https://doi.org/10.3390/psych3020017</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Edgar Merkle, Yves Rosseel, Ben Goodrich.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
